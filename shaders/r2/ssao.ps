#include "common.h"

static const half2 poisson_disc12[12] = 
{
	half2(-0.326212f , -0.405810f),
	half2(-0.840144f , -0.073580f),
	half2(-0.695914f ,  0.457137f),
	half2(-0.203345f ,  0.620716f),
	half2( 0.962340f , -0.194983f),
	half2( 0.473434f , -0.480026f),
	half2( 0.519456f ,  0.767022f),
	half2( 0.185461f , -0.893124f),
	half2( 0.507431f ,  0.064425f),
	half2( 0.896420f ,  0.412458f),
	half2(-0.321940f , -0.932615f),
	half2(-0.791559f , -0.597710f)
};


//	Screen space ambient occlusion
//	P	screen space position of the original point
//	N	screen space normal of the original point
//	tc	G-buffer coordinates of the original point
half	calc_ssao( half3 P, half3 N, half2 tc)
{
	half point_depth = P.z;
	if (point_depth<0.01) point_depth = 100000.0h;	//	filter for the sky
//	half2 	scale 	= half2	(.5f / 1024.h, .5f / 768.h)*100/point_depth;
//	half2 	scale 	= half2	(.5f / 1024.h, .5f / 768.h)*100/max(point_depth,1.3);
	half2 	scale 	= half2	(.5f / 1024.h, .5f / 768.h)*150/max(point_depth,1.3);
//	half2 	scale 	= half2	(.5f / 1024.h, .5f / 768.h)*70/point_depth;

	// sample 
	half 	occ	= 0.1h;	
	half num_dir	= 0.1h;
//	half 	occ	= 1.0h;
//	half num_dir	= 1.0h;

for (int a=1; a<3; ++a)
{
	half2	scale_tmp = scale*a;
	for (int i=0; i<12; i++)
	{
		float2 	tap 	= tc + poisson_disc12[i]*scale_tmp;
		half3	tap_pos	= tex2D	(s_position,tap);
		half3 	dir 	= tap_pos-P.xyz;
		half	dist	= length(dir);
			dir 	= normalize(dir);
		half 	infl 	= saturate(dot( dir, N.xyz));
		half 	occ_factor = saturate(dist);

		{
//			occ += lerp( 1, occ_factor, infl);
//			num_dir += 1;		

			occ += (infl+0.01)*lerp( 1, occ_factor, infl)/(occ_factor+0.1);
			num_dir += (infl+0.01)/(occ_factor+0.1);

//			occ += (infl+0.1)*lerp( 1, occ_factor, infl)/(occ_factor+0.1);
//			num_dir += (infl+0.1)/(occ_factor+0.1);

//			occ += (infl+0.1)*lerp( 1, occ_factor, infl);
//			num_dir += (infl+0.1);
		}
	}
}
	occ /= num_dir;

	return occ;
}